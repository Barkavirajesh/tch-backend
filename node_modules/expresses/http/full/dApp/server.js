const express = require("express");
const mongoose = require("mongoose");
const conn = require("./conn.js");

const app = express();

app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(express.static("public"));

const userSchema = new mongoose.Schema({
  name: { required: true, type: String },
  email: { required: true, type: String },
  password: { required: true, type: String },
  age: { required: true, type: Number },
  marks: { required: true, type: Number },
});

const UserModel = mongoose.model("User", userSchema);

//login

app.post("/api/login/", async (req, res) => {
  const { email, password } = req.body;
  console.log(req.body);

  const user = await UserModel.findOne({ email, password });

  if (user) {
    res.json({ user: user, message: "Login Success" });
  } else {
    res.json({ message: "Login Failed" });
  }
});

// get all users

app.get("/api/users/", async (req, res) => {
  const usres = await UserModel.find();
  if (usres) {
    res.json({ users: usres });
  } else {
    res.json({ message: "No users found" });
  }
});

// add new User

app.post("/api/adduser/", async (req, res) => {
  const newuser = new UserModel(req.body);
  await newuser.save();
  res.json({ message: "User added successfully" });
});

//delete user

app.delete("/api/deleteuser/:id", async (req, res) => {
  const id = req.params.id;
  await UserModel.deleteOne({ _id: id });
  res.json({ message: "User deleted successfully" });
});

// update user

app.put("/api/updateuser/:id", async (req, res) => {
  const id = req.params.id;
  const user = await UserModel.findByIdAndUpdate(id, req.body);
  if (user) {
    res.json({ message: "User updated successfully" });
  } else {
    res.json({ message: "User not found" });
  }
});

app.get("/", (req, res) => {
  res.sendFile(__dirname + "/public/index.html");
});

const PORT = 3000;
app.listen(PORT, () => {
  console.log(`Server is running on http://localhost:${PORT}`);
});
